# GitHub Outside Collaborators

[![repo standards badge](https://img.shields.io/endpoint?labelColor=231f20&color=005ea5&style=for-the-badge&label=MoJ%20Compliant&url=https%3A%2F%2Foperations-engineering-reports.cloud-platform.service.justice.gov.uk%2Fapi%2Fv1%2Fcompliant_public_repositories%2Fendpoint%2Fgithub-collaborators&logo=data:image/png;base64,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)](https://operations-engineering-reports.cloud-platform.service.justice.gov.uk/public-github-repositories.html#github-collaborators)

Manage MoJ GitHub Organisation outside collaborators via code.

## Adding Collaborators

A Collaborator can be added to multiple repositories via the [form](https://github.com/ministryofjustice/github-collaborators/issues/new?assignees=&labels=collaborator%2Cpr-create-issue&template=create-pr-from-issue.yaml&title=Please+create+an+outside+collaborator+pull+request+) located in `Issues -> New Issue -> Create a Outside Collaborator Pull Request -> Get Started`. This form will automatically create a pull request with the collaborator added to the relevant Terraform files.

If you want to allow access to an MoJ GitHub repository for an outside collaborator, you can manually add/remove/edit the Terraform file/s, see the [Defining Collaborators](https://github.com/ministryofjustice/github-collaborators#defining-collaborators) section, followed by a new pull request with the required changes to the corresponding `terraform/[repository-name].tf` file/s.

If you are not confident editing Terraform file/s, you can raise an issue using this template [questionnare](https://github.com/ministryofjustice/github-collaborators/issues/new?assignees=&labels=&template=access-request.md) to request access for a collaborator, and we will make the changes for you.

## Full Org Members who are Collaborators

Certain Collaborators need full MoJ GitHub Organization membership so that they can be added to a GitHub team for various reasons. These users still need to be tracked within this repository. Once the collaborator is added to one .tf file in the terraform folder the application will detect that the user is both a collaborator and a full Org member. The application will track which repositories the user has access to and create either a pull request to add or remove the collaborator from the matching .tf file in the terraform folder. These pull requests can be automatically approved by a member of the team because access has already been granted via a team or access has been revoked for the team. When a pull request to add a user to a .tf is merged in and tf apply is executed, Terraform adds the collaborator to the repository as a direct user. This means the user will have direct access and access via a team to the repository. A member of the team **must** manually remove the users direct access to the repository after tf apply has finished. Failure to remove the user will result in the Operations-Engineering repository automation moving that user into a new or existing repository autogenerated team. This will mean the user will be added to the repository via two teams. If the user is removed from the original team then the application will not be able to tell that the user's original access has been reverted and their access in the .tf file should be revoked as well. Full Org members still have a review date. When the review date is ready for renewal a PR to remove the user will be created one week before. This is time to review whether the user still requires access to the repository and full Org membership.

> PRs from forks do NOT work with the current automated process, please only create PRs from a branch.

## Background

Sometimes we need to grant access to one of more of our GitHub repositories to people who are not part of the "ministryofjustice" GitHub organisation. This often happens when we engage third-party suppliers to carry out work on our behalf.

Github allows users called outside collaborators who are not part of the organisation access to an organisations repositories. We can grant a certain level of access to a specific repository to an individual GitHub user account.

Rather than manage this via "clickops" this repository enables us to manage these relationships via Terraform code. This also means we can attach metadata to the collaborator relationship, to explain its purpose. This will help to ensure that collaborators are removed when they no longer need access to the relevant GitHub repositories.

## How it works

- The `terraform/` directory contains a file per repository that has collaborators, defining the collaboration with metadata. The name of the file is the repository name with any `.` characters replaced with `-` to render the name acceptable for Terraform. i.e. the file for repository `foo.bar` will be `terraform/foo-bar.tf`
- Github actions run `terraform plan` and `terraform apply` to keep the collaborations in GitHub in sync with the Terraform source code
- The `terraform plan` and `terraform apply` use the Terraform module [github_repository_collaborator](https://registry.terraform.io/providers/integrations/github/latest/docs/resources/repository_collaborator) to add Outside Collaborators, who are defined in the Terraform source code, to the MoJ Github Organisation repositories.
- Ruby code in the `bin/` and `lib/` directories (with unit tests in the `spec/` directory) queries GitHub via the REST API and GraphQL API to retrieve all the collaborator relationships which exist.
- A GitHub action runs daily that compares the collaborators in GitHub with the Terraform source code. Any collaborators which are not fully specified in the Terraform source code are removed from found repositories.

## Removing Collaborators

1. If the collaborator is defined in Terraform code

- Manual: Edit the Terraform file to remove the collaborator and raise a pull request to remove the collaborator from the repository.

- Manual: This [GitHub Action](https://github.com/ministryofjustice/github-collaborators/actions/workflows/remove-collaborator.yml) will edit and create the pull request to remove a specific collaborator from a repository:

  1. Click the `Run workflow` button
  2. Enter the repository name and the username of the collaborator to remove
  3. Click `Run workflow`

- Automatically: The collaborator will be removed from the repository and Terraform file/s once their review_date has expired.

2. If the collaborator is not defined in Terraform code

- This will be the case if access was granted by a repository administrator via the GitHub UI. Our automation will automatically remove that user from the repository, raise an issue on that repository, and inform us that the user was added to the repository incorrectly.

## Defining collaborators

To define collaborators on a repository, first add a Terraform file corresponding to the repository name (unless there already is one).

The filename should be `<repository-name>.tf` where `repository-name` is the repository name **with any `.` characters replaced by `-`**

The file should contain:

```
module "<repository-name>" {
  source     = "./modules/repository-collaborators"
  repository = "<repository-name>"
  collaborators = [
  ]
}
```

> The value of `repository` inside the file should be the exact name of the repository, with no substitutions. i.e. if the repository is called `ministryofjustice/foo.bar` then put `repository = "foo.bar"`

To add collaborators to the repository, define each of them inside a `collaborators` block, with the following information inside the quotation marks:

```
    {
      github_user  = "<github username>"
      permission   = "push"  #  pull|push|admin
      name         = ""  #  The name of the person behind github_user
      email        = ""  #  Their email address
      org          = ""  #  The organisation/entity they belong to
      reason       = ""  #  Why is this person being granted access?
      added_by     = ""  #  Who made the decision to grant them access? e.g. 'Awesome Team <awesome.team@digital.justice.gov.uk>'
      review_after = ""  #  Date after which this grant should be reviewed/revoked, e.g. 2021-11-26
    },
```

An example, please do not add the comments to the file:

```
  collaborators = [
    {
      github_user  = "someuser"
      permission   = "admin"
      name         = "Real Name"
      email        = "name@acme.com"
      org          = "Acme. Corp."
      reason       = "Acme are building some stuff for us"
      added_by     = "Team Name <team-name@digital.justice.gov.uk>"
      review_after = "2021-11-26"
    },
  ]
```

The `added_by` line should contain an approvers email address that uses @digital.justice.gov.uk or @justice.gov.uk

You can add comments (prefixed with `#` on every line) to these files to provide additional context/information.

## Pre-requisites

To run Terraform apply locally:

- Terraform

### Environment Variables

To run Terraform apply locally:

- `OPS_BOT_TOKEN` must contain a GitHub personal access token (PAC) enabled for MoJ SSO, with the following scopes:

  - admin:org
  - repo
  - read:user
  - user:email

- `TERRAFORM` must define the Terraform executable (e.g. `/usr/local/bin/terraform0.13.5`)

- `AWS_ACCESS_KEY_ID` & `AWS_SECRET_ACCESS_KEY` - credentials with access to the S3 bucket holding the Terraform state file

See [env.example](./env.example) for more more information.

## Usage

### [bin/outside-collaborators.rb](.github/workflows/outside-collaborators-check.yaml)

This script is run on daily basis by the [GitHub action](https://github.com/ministryofjustice/github-collaborators/actions/workflows/outside-collaborators-check.yaml). You can also run it manually by triggering the action. To run it locally:

```
ruby bin/outside-collaborators.rb
```

The script checks collaborators in Terraform against collaborators in GitHub repositories. Unknown collaborators are removed from those repositories. Issues will be raised on repositories when collaborator expiry date is up for renewal or expired. Slack alerts and repository pull requests are automatically generated when a collaborator expiry is up for renewal and has expired. It will output all outside collaborators who are defined in the Terraform code compared to the collaborators on GitHub per repository and state which collaborators are missing. It will delete expired collaborator invites to a repository which has not been accepted within the allowed time.

## Documentation

Yard is used for documentation. It creates a html report within the `doc` folder:

```
gem install yard
yardoc 'lib/**/*.rb'
```

## Development

Install `bundler` (`gem install bundler`) then run `bundle install` to install the dependencies.

To run the unit tests use `bundle exec rspec` or `rspec`.

`rspec` will generate a code coverage report using simplecov and create a `coverage` folder. Open the report using `open coverage/index.html`

Install `rspec` and `ruby-debug-ide` (locally for VS-Code to debug the tests):

```
gem install rspec --install-dir ./bin
sudo gem install ruby-debug-ide
```

To debug in VS Code use the below launch configrations within `.vscode/launch.json`:

```
{
  "version": "0.2.0",
  "configurations": [
    {
      "name": "Python",
      "type": "python",
      "python": "${workspaceFolder}/venv/bin/python3",
      "request": "launch",
      "cwd": "${workspaceRoot}",
      "program": "${workspaceFolder}/scripts/check-collaborators-username.py",
      "console": "integratedTerminal",
      "args": [""]
    },
    {
      "name": "Ruby - File",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/close-issues.rb",
      "env": {
        "REALLY_POST_TO_SLACK": "0",
        "REALLY_POST_TO_GH": "0",
        "OPS_BOT_TOKEN_ENABLED": "0",
        "OPS_BOT_TOKEN": "add-ops-bot-token",
        "LOG_LEVEL": "debug",
        "SLACK_WEBHOOK_URL": "add-slack-link",
      }
    },
    {
      "name": "RSpec - file",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/bin/rspec",
      "args": ["${file}"]
    },
    {
      "name": "RSpec - all",
      "type": "Ruby",
      "request": "launch",
      "program": "${workspaceRoot}/bin/bin/rspec",
      "args": ["-I", "${workspaceRoot}"]
    }
  ]
}

```
